# 中断

操作系统是中断驱动的，没有中断驱动操作系统可能就停在某个循环中无法跳出了，也只能对单一的任务进行处理

## 一、中断的分类

### 1.1 外部中断

外部中断是CPU外部的中断，中断来源是外部的某个器件

<img title="" src="./0 杂项/图片资源/94130828-5c9a-46f9-b0a9-4dd7f10043cd.png" alt="loading-ag-3105" data-align="center">  

+ 可屏蔽中断

    可以设置ELFAGS寄存器的 IF位来屏蔽或者使能

    可屏蔽中断是一些外部信息的通知由<mark>INTR</mark>进入CPU，这种中断是不影响系统运行的，随时可以进行处理，甚至CPU可以不进行处理。

+ 不可屏蔽中断(中断向量号为2)

    不能进行屏蔽

    不可屏蔽中断是通过NMI来进入CPU，这种基本是致命错误，计算机没办法继续运行下去。

### 1.2 内部中断

+ 软中断

    软中断是软件主动发起的，并不是错误，可以理解为一种请求。软中断也无视IF位。例如 int 8

+ 异常

    例如，除以0引发的0号异常、无法识别机器码的6号异常等。某些异常会有单独的<mark>错误码 error code</mark> ，进入中断时CPU会把它压入栈中。



## 二、中断描述符表IDT

当CPU接收到一个中断时，需要用**中断向量**在IDT种检索对应的描述符，描述符中找到中断处理程序的起始地址，然后执行中断处理程序。

中断描述符表示如下：

![loading-ag-3698](./0%20杂项/图片资源/ad427b6c-6a77-41ab-937e-6c6603c3a37e.png)

> 中断门、调用门、任务门、陷阱门都可以放在中断描述符表中

那如何加载中断描述符呢？答案是放在IDTR中：

<img title="" src="./0 杂项/图片资源/4d353b72-39c5-439f-9102-e2b89b265df3.png" alt="loading-ag-3712" data-align="center">

加载方法：

```nasm
lidt 48位内存数据
```

## 三、中断处理流程

<img title="" src="./0 杂项/图片资源/855c7ca6-6115-4349-9284-caddbc6f7951.png" alt="loading-ag-4141" data-align="center">

> 1.外部设备的中断 由 中断代理芯片接受  将中断向量号发给CPU
> 
> 2.处理器根据中断向量号，确定中断门描述符
> 
>     也就是 向量号 * 8 + idtr存的基址 
> 
> 3.处理器进行特权检查
> 
>    <mark> CPL</mark> 必须 在<mark>门描述符DPL</mark> 和中断<mark>目标代码段DPL</mark>之间（一般是从3特权变0特权，使用中断门当跳板提升特权等级）
> 
> 4.执行中断处理程序
> 
>     CS变成目标代码段的选择子，EIP变成其偏移地址

中断发生后<mark>NT（嵌套标志）和 eflags中的IF位会被置0</mark>.

+ IF置0避免中断嵌套 ： 若中断处理过程中又来了个新的中断，会引发 **“一般保护性（GP）异常**”。

+ 任务门和陷阱们的IF不会清0

在中断处理完成后，返回指令为"iret".为啥不用ret呢？之后再详细介绍这其中的原因。

## 四、中断场景下的栈 及 iret指令

### 4.1 中断发生后的栈帧

1）假设在发生中断时是从3特权级到0特权级，此时3特权级的栈SS和ESP会保存到0特权级的栈中。

2）将新的栈中压入EFLAGS寄存器

3）由于要切换代码段，对于段间转移 将CS_old和EIP_old入栈

4）某些异常会有错误码，此时还会压入ERROR_CODE(这个不是一定有的)

> 如果没有发生特权级别的转移，那就不会存SS_old和ESP_old

此时的栈帧如下：

<img title="" src="./0 杂项/图片资源/54631872-6af7-418f-a1bb-6eb752172c03.png" alt="loading-ag-4196" data-align="center">

### 4.2 iret指令

此时的栈帧决定着我们没办法直接用ret来进行返回。在中断服务程序执行完毕后，还要返回被中断的进程，使用的是<mark>iret指令</mark>。在使用iret时需要保证栈中的数据，此部分从栈顶往上的顺序为：EIP、CS、EFLAGS、[ESP，SS]。才能够正常返回（有ERROR CODE时需要将ERROR_CODE手动弹出）

### 4.3 中断错误码ERROR_CODE

<img title="" src="file:///E:/笔记/操作系统真相还原/0 杂项/图片资源/0094c777-5cee-47d4-8a34-019e137420c4.png" alt="loading-ag-4221" data-align="center">

## 五、开启中断流程

1）构造好IDT

2）提供中断向量号

## 六、设计示例
